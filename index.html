<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ChinchonAD</title>
<style>
  body { font-family: monospace; background: #2e7d32; color: #fff; margin:0; padding:0; }
  #loginPanel, #gamePanel { display: none; text-align: center; padding:20px; }
  #hand, #discard, #players { margin: 20px; }
  .card { display: inline-block; width: 60px; height: 90px; background: #fff; color: #000; border-radius: 8px; line-height: 90px; font-size: 24px; margin: 5px; cursor: pointer; }
  button { padding: 10px 15px; margin: 5px; font-size: 16px; cursor: pointer; }
  #players { position: absolute; right:10px; top:10px; text-align:left; }
</style>
</head>
<body>

<div id="loginPanel">
  <h1>ChinchonAD - Login / Registro</h1>
  <div>
    <input type="text" id="username" placeholder="Usuario">
    <input type="password" id="password" placeholder="Contraseña">
    <button id="registerBtn">Registrarse</button>
    <button id="loginBtn">Iniciar Sesión</button>
  </div>
  <div id="loginMessage"></div>
</div>

<div id="modePanel">
  <h2>Selecciona modo de juego</h2>
  <button id="botModeBtn">Jugar contra Bot</button>
  <button id="friendsModeBtn">Jugar con Amigos</button>
</div>

<div id="gamePanel">
  <h2>ChinchonAD</h2>
  <div>Mazo: <button id="drawDeck">Tomar carta del mazo</button></div>
  <div>Descarte: <span id="discard"></span></div>
  <div id="hand"></div>
  <div id="players"></div>
  <button id="logoutBtn">Cerrar Sesión</button>
</div>

<script>
// ---- VARIABLES ----
const loginPanel = document.getElementById('loginPanel');
const modePanel = document.getElementById('modePanel');
const gamePanel = document.getElementById('gamePanel');

const usernameInput = document.getElementById('username');
const passwordInput = document.getElementById('password');
const loginMessage = document.getElementById('loginMessage');

let currentUser = null;

const suits = ['♠','♥','♦','♣'];
const values = ['A','2','3','4','5','6','7','8','9','10','J','Q','K'];
let deck = [];
let discardPile = [];
let hand = [];
let players = [];

// ---- LOGIN / REGISTRO ----
loginPanel.style.display = 'block';
modePanel.style.display = 'none';
gamePanel.style.display = 'none';

function getUsers(){
  return JSON.parse(localStorage.getItem('chinchon_users')||'{}');
}

function saveUsers(users){
  localStorage.setItem('chinchon_users', JSON.stringify(users));
}

document.getElementById('registerBtn').onclick = ()=>{
  const username = usernameInput.value.trim();
  const password = passwordInput.value;
  if(!username || !password){ loginMessage.innerText='Completa usuario y contraseña'; return;}
  let users = getUsers();
  if(users[username]){ loginMessage.innerText='Usuario ya existe'; return;}
  users[username]=password;
  saveUsers(users);
  loginMessage.innerText='Registrado! Ahora inicia sesión';
}

document.getElementById('loginBtn').onclick = ()=>{
  const username = usernameInput.value.trim();
  const password = passwordInput.value;
  let users = getUsers();
  if(users[username] && users[username]===password){
    currentUser = username;
    loginPanel.style.display='none';
    modePanel.style.display='block';
  } else {
    loginMessage.innerText='Usuario o contraseña incorrectos';
  }
}

// ---- MODO DE JUEGO ----
document.getElementById('botModeBtn').onclick = ()=>{
  modePanel.style.display='none';
  startGame('bot');
}
document.getElementById('friendsModeBtn').onclick = ()=>{
  modePanel.style.display='none';
  startGame('friends');
}

document.getElementById('logoutBtn').onclick = ()=>{
  location.reload();
}

// ---- FUNCIONES DEL JUEGO ----
function createDeck(){
  deck = [];
  for(let s of suits){
    for(let v of values){
      deck.push({suit:s,value:v});
    }
  }
  shuffle(deck);
}

function shuffle(array){
  for(let i=array.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [array[i],array[j]]=[array[j],array[i]];
  }
}

function drawCard(fromDeck=true){
  let card;
  if(fromDeck){
    if(deck.length===0) return;
    card = deck.pop();
  } else {
    if(discardPile.length===0) return;
    card = discardPile.pop();
  }
  hand.push(card);
  renderHand();
  renderDiscard();
}

function discardCard(index){
  const card = hand.splice(index,1)[0];
  discardPile.push(card);
  renderHand();
  renderDiscard();
  updateScore(currentUser,-10);
}

function renderHand(){
  const handDiv = document.getElementById('hand');
  handDiv.innerHTML='';
  hand.forEach((c,i)=>{
    const cardDiv=document.createElement('div');
    cardDiv.className='card';
    cardDiv.innerText=c.value+c.suit;
    cardDiv.onclick=()=>discardCard(i);
    handDiv.appendChild(cardDiv);
  });
}

function renderDiscard(){
  const discardSpan=document.getElementById('discard');
  if(discardPile.length>0){
    const top=discardPile[discardPile.length-1];
    discardSpan.innerText=top.value+top.suit;
  } else {
    discardSpan.innerText='(vacío)';
  }
}

function updateScore(playerName,value){
  const p = players.find(pl=>pl.name===playerName);
  if(p){
    p.points += value;
  } else {
    players.push({name:playerName,points:value});
  }
  players.sort((a,b)=>a.points-b.points);
  renderPlayers();
}

function renderPlayers(){
  const playersDiv=document.getElementById('players');
  playersDiv.innerHTML='';
  players.forEach(pl=>{
    playersDiv.innerText+=`${pl.name}: ${pl.points} puntos\n`;
  });
}

function startGame(mode){
  gamePanel.style.display='block';
  createDeck();
  hand=[];
  discardPile=[];
  for(let i=0;i<7;i++) drawCard(true);
  updateScore(currentUser,0);
}
</script>
</body>
</html>